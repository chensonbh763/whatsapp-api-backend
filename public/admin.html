<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Admin - LucreMaisTask</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 20px;
      background: #f7f7f7;
    }

    h2 {
      color: #2a8f43;
      margin-bottom: 10px;
    }

    section {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    input, textarea, button, select {
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      background: #2a8f43;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #1c6e34;
    }

    pre {
      background: #eee;
      padding: 10px;
      white-space: pre-wrap;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
  </style>
</head>
<body>

  <h2>üõ†Ô∏è Painel Admin - LucreMaisTask</h2>

  <!-- Testar conex√£o -->
  <section>
    <h3>‚úÖ Testar conex√£o com o banco</h3>
    <button onclick="testarConexao()">Testar</button>
    <pre id="resultadoConexao">Aguardando...</pre>
  </section>

  <!-- Consultar usu√°rio -->
  <section>
    <h3>üîç Consultar usu√°rio por email</h3>
    <input id="emailConsulta" type="email" placeholder="Digite o email do usu√°rio" />
    <button onclick="consultarUsuario()">Consultar</button>
    <div id="resultadoConsulta">Nenhum resultado ainda.</div>
  </section>

  <!-- Criar usu√°rio -->
  <section>
    <h3>‚ûï Criar novo usu√°rio</h3>
    <input id="nomeUsuario" type="text" placeholder="Nome" />
    <input id="emailUsuario" type="email" placeholder="Email" />
    <input id="senhaUsuario" type="password" placeholder="Senha" />
    <input id="celularUsuario" type="text" placeholder="Celular" />
    <input id="cpfUsuario" type="text" placeholder="CPF" />
    <select id="planoUsuario">
      <option value="1">Plano B√°sico</option>
      <option value="2">Plano VIP</option>
    </select>
    <button onclick="criarUsuario()">Criar usu√°rio</button>
    <pre id="respostaCriarUsuario">Aguardando...</pre>
  </section>

  <!-- Atualizar usu√°rio -->
  <section>
    <h3>‚úèÔ∏è Atualizar plano do usu√°rio</h3>
    <input id="emailAtualizar" type="email" placeholder="Email do usu√°rio" />
    <select id="planoAtualizar">
      <option value="1">Plano B√°sico</option>
      <option value="2">Plano VIP</option>
    </select>
    <button onclick="atualizarPlano()">Atualizar</button>
    <pre id="respostaAtualizar">Aguardando...</pre>
  </section>

  <!-- Remover usu√°rio -->
  <section>
    <h3>‚ùå Remover usu√°rio</h3>
    <input id="emailRemover" type="email" placeholder="Email do usu√°rio" />
    <button onclick="removerUsuario()">Remover</button>
    <pre id="respostaRemover">Aguardando...</pre>
  </section>
  <section>
    <h3>üîê Consultar Acessos</h3>
    <input id="emailAcesso" type="text" placeholder="Digite o email para filtrar (opcional)" />
    <button onclick="consultarAcessos()">Consultar</button>
    <pre id="respostaAcessos">Nenhum resultado ainda.</pre>
  </section>

  <script>
    async function consultarAcessos() {
      const email = document.getElementById("emailAcesso").value;
      let sql = "SELECT id, data_login, email, ip, dispositivo_id FROM acessos";
      if (email) {
        sql += " WHERE email = '" + email + "'";
      }
      sql += " ORDER BY data_login DESC LIMIT 50";

      try {
        const res = await fetch("/admin/sql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sql })
        });

        const text = await res.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch {
          document.getElementById("respostaAcessos").innerHTML = "<pre>" + text + "</pre>";
          return;
        }

        if (Array.isArray(result) && result.length > 0) {
          const keys = Object.keys(result[0]);
          let tabela = "<table border='1' cellpadding='8'><tr>";
          keys.forEach(k => tabela += `<th>${k}</th>`);
          tabela += "<th>A√ß√µes</th></tr>";

          result.forEach(row => {
            tabela += "<tr>";
            keys.forEach(k => tabela += `<td>${row[k]}</td>`);
            tabela += `<td><button onclick="removerAcesso(${row.id})">Remover</button></td>`;
            tabela += "</tr>";
          });
          tabela += "</table>";

          document.getElementById("respostaAcessos").innerHTML = tabela;
        } else {
          document.getElementById("respostaAcessos").innerHTML = "<pre>Nenhum acesso encontrado</pre>";
        }
      } catch (err) {
        document.getElementById("respostaAcessos").innerHTML = "<pre>‚ùå Erro: " + err + "</pre>";
      }
    }

    async function removerAcesso(id) {
      if (!confirm("Tem certeza que deseja remover este acesso?")) return;

      try {
        const res = await fetch("/admin/sql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sql: "DELETE FROM acessos WHERE id = " + id })
        });

        const text = await res.text();
        alert("Resultado: " + text);
        consultarAcessos();
      } catch (err) {
        alert("‚ùå Erro: " + err);
      }
    }
  </script>

  <!-- Executar SQL -->
  <section>
    <h3>üìÑ Executar comando SQL</h3>
    <textarea id="sql" rows="4" placeholder="Escreva seu comando SQL aqui..."></textarea>
    <button onclick="executarSQL()">Executar SQL</button>
    <pre id="respostaSQL">Nenhum resultado ainda.</pre>
  </section>

  <script>
    async function testarConexao() {
      try {
        const res = await fetch("/api/tarefas");
        const data = await res.json();
        document.getElementById("resultadoConexao").textContent =
          "‚úÖ Conectado com sucesso! Tarefas carregadas: " + data.length;
      } catch (err) {
        document.getElementById("resultadoConexao").textContent =
          "‚ùå Erro ao conectar: " + err;
      }
    }



    async function consultarUsuario() {
      const email = document.getElementById("emailConsulta").value;
      const sql = `
        SELECT u.id, u.nome, u.email, p.nome AS plano, u.celular, u.cpf, u.criado_em
        FROM usuarios u
        JOIN planos p ON u.plano_id = p.id
        WHERE u.email = '${email}';
      `;

      try {
        const res = await fetch("/admin/sql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sql })
        });

        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          const keys = Object.keys(data[0]);
          let tabela = "<table><tr>";
          keys.forEach(k => tabela += `<th>${k}</th>`);
          tabela += "</tr>";
          data.forEach(row => {
            tabela += "<tr>";
            keys.forEach(k => tabela += `<td>${row[k]}</td>`);
            tabela += "</tr>";
          });
          tabela += "</table>";
          document.getElementById("resultadoConsulta").innerHTML = tabela;
        } else {
          document.getElementById("resultadoConsulta").innerHTML = "<pre>Nenhum usu√°rio encontrado</pre>";
        }
      } catch (err) {
        document.getElementById("resultadoConsulta").innerHTML = "<pre>‚ùå Erro: " + err + "</pre>";
      }
    }

    async function criarUsuario() {
      const sql = `
        INSERT INTO usuarios (nome, email, senha, celular, cpf, plano_id)
        VALUES (
          '${document.getElementById("nomeUsuario").value}',
          '${document.getElementById("emailUsuario").value}',
          '${document.getElementById("senhaUsuario").value}',
          '${document.getElementById("celularUsuario").value}',
          '${document.getElementById("cpfUsuario").value}',
          ${document.getElementById("planoUsuario").value}
        );
      `;

      try {
        const res = await fetch("/admin/sql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sql })
        });
        const text = await res.text();
        document.getElementById("respostaCriarUsuario").textContent = text;
      } catch (err) {
        document.getElementById("respostaCriarUsuario").textContent = "‚ùå Erro: " + err;
      }
    }

    async function atualizarPlano() {
      const sql = `
        UPDATE usuarios
        SET plano_id = ${document.getElementById("planoAtualizar").value}
        WHERE email = '${document.getElementById("emailAtualizar").value}';
      `;

      try {
        const res = await fetch("/admin/sql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sql })
        });
        const text = await res.text();
        document.getElementById("respostaAtualizar").textContent = text;
      } catch (err) {
        document.getElementById("respostaAtualizar").textContent = "‚ùå Erro: " + err;
      }
    }

    async function removerUsuario() {
      const sql = `
        DELETE FROM usuarios
        WHERE email = '${document.getElementById("emailRemover").value}';
      `;

      try {
        const res = await fetch("/admin/sql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sql })
        });
        const text = await res.text();
        document.getElementById("respostaRemover").textContent = text;
      } catch (err) {
        document.getElementById("respostaRemover").textContent = "‚ùå Erro: " + err;
      }
    }

    async function executarSQL() {
      const sql = document.getElementById("sql").value;

      try {
        const res = await fetch("/admin/sql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sql })
        });

        const text = await res.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch {
          document.getElementById("respostaSQL").innerHTML = "<pre>" + text + "</pre>";
          return;
        }

        if (Array.isArray(result) && result.length > 0) {
          const keys = Object.keys(result[0]);
          let tabela = "<table><tr>";
          keys.forEach(k => tabela += `<th>${k}</th>`);
          tabela += "</tr>";
          result.forEach(row => {
            tabela += "<tr>";
            keys.forEach(k => tabela += `<td>${row[k]}</td>`);
            tabela += "</tr>";
          });
          tabela += "</table>";

          document.getElementById("respostaSQL").innerHTML = tabela;
        } else {
          document.getElementById("respostaSQL").innerHTML = "<pre>" + JSON.stringify(result, null, 2) + "</pre>";
        }
      } catch (err) {
        document.getElementById("respostaSQL").innerHTML = "<pre>‚ùå Erro: " + err + "</pre>";
      }
    }
  </script>

</body>
</html>

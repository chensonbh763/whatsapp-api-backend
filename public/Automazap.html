<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Automa√ß√£o WhatsApp</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
      margin: 0;
      padding: 40px;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: #ffffff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    section {
      margin-bottom: 40px;
      border-bottom: 1px solid #eee;
      padding-bottom: 20px;
    }

    h2 {
      font-size: 22px;
      margin-bottom: 10px;
      color: #1a73e8;
    }

    p {
      font-size: 16px;
      margin-bottom: 10px;
    }

    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-right: 10px;
    }

    button:hover {
      background-color: #155ab6;
    }

    input[type="file"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
    }

    textarea {
      resize: vertical;
      height: 120px;
    }

    .image-box {
      width: 100%;
      height: 200px;
      background-color: #f0f0f0;
      border: 2px dashed #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      border-radius: 8px;
      overflow: hidden;
      font-weight: 500;
      color: #666;
    }

    .grupo-selecao {
      margin-bottom: 15px;
    }

    .temporizador label {
      display: inline-block;
      margin-right: 20px;
      font-size: 15px;
    }

    #statusConexao,
    #status,
    #ultimaMensagem,
    #resumoEnvio {
      font-weight: 500;
      margin-top: 10px;
    }

    #qr-container {
      margin-top: 20px;
      text-align: center;
    }

    #qr-container img {
      max-width: 300px;
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 8px;
    }

    @media (max-width: 600px) {
      .container {
        padding: 20px;
      }

      button {
        width: 100%;
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Cabe√ßalho -->
    <section class="cabecalho">
      <h2><i class="fab fa-whatsapp"></i> Automa√ß√£o WhatsApp</h2>
      <p>Sistema premium para enviar mensagens autom√°ticas em grupos do WhatsApp com texto, imagem e temporizador.</p>
      <button id="verificar"><i class="fas fa-link"></i> Verificar Conex√£o</button>
      <p id="statusConexao">Status: aguardando verifica√ß√£o...</p>
    </section>

    <div id="qr-container"></div>

    <!-- Imagem -->
    <section class="imagem">
      <h2><i class="fas fa-image"></i> Imagem</h2>
      <div id="preview" class="image-box">Pr√©-visualiza√ß√£o</div>
      <input type="file" id="imageInput" accept="image/*">
    </section>

    <!-- Texto -->
    <section class="texto">
      <h2><i class="fas fa-comment-dots"></i> Mensagem</h2>
      <textarea id="mensagem" placeholder="Digite sua mensagem aqui..."></textarea>
    </section>

    <!-- Grupos -->
    <section class="grupos">
      <h2><i class="fas fa-users"></i> Grupos</h2>
      <div class="grupo-selecao">
        <label for="grupo1">Grupo 1:</label>
        <select id="grupo1"><option value="">Selecione</option></select>
      </div>
      <div class="grupo-selecao">
        <label for="grupo2">Grupo 2:</label>
        <select id="grupo2"><option value="">Selecione</option></select>
      </div>
      <div class="grupo-selecao">
        <label for="grupo3">Grupo 3:</label>
        <select id="grupo3"><option value="">Selecione</option></select>
      </div>
      <div class="grupo-selecao">
        <label for="grupo4">Grupo 4:</label>
        <select id="grupo4"><option value="">Selecione</option></select>
      </div>
      <div class="grupo-selecao">
        <label for="grupo5">Grupo 5:</label>
        <select id="grupo5"><option value="">Selecione</option></select>
      </div>
    </section>

    <!-- Temporizador -->
    <section class="temporizador">
      <h2><i class="fas fa-clock"></i> Temporizador</h2>
      <label><input type="radio" name="tempo" value="30"> 30 minutos</label>
      <label><input type="radio" name="tempo" value="60"> 1 hora</label>
    </section>

    <!-- Enviar -->
    <section class="enviar">
      <h2><i class="fas fa-paper-plane"></i> Status</h2>
      <p id="status">Aguardando mensagem...</p>
      <p id="ultimaMensagem">Primeira mensagem enviada: --:--</p>
      <p id="resumoEnvio">Mensagens enviadas: 0 de 5</p>
      <button id="enviar"><i class="fas fa-play"></i> Enviar</button>
      <button id="parar"><i class="fas fa-stop"></i> Parar</button>
    </section>

  </div>


<script>
  // ‚úÖ Verificar conex√£o e carregar grupos se conectado
  document.getElementById("verificar").addEventListener("click", async () => {
    try {
      const res = await fetch("http://localhost:3000/verificar");
      const data = await res.json();
      document.getElementById("statusConexao").innerText = "Status: " + data.status;

      const qrContainer = document.getElementById("qr-container");

      if (data.status === "desconectado") {
        const qrRes = await fetch("http://localhost:3000/qr");
        if (qrRes.ok) {
          const qrData = await qrRes.json();
          qrContainer.innerHTML = `<img src="${qrData.qr}" alt="QR Code" style="max-width:300px; border: 2px solid #ccc; padding: 10px;">`;
        } else {
          qrContainer.innerText = "QR Code n√£o dispon√≠vel";
        }
      } else {
        qrContainer.innerHTML = "";
        carregarGrupos(); // ‚úÖ S√≥ carrega os grupos se estiver conectado
      }
    } catch (erro) {
      document.getElementById("statusConexao").innerText = "Status: erro ao verificar conex√£o";
      console.error("Erro na verifica√ß√£o:", erro);
    }
  });

  // üñºÔ∏è Preview da imagem
  const imageInput = document.getElementById("imageInput");
  const preview = document.getElementById("preview");
  imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        preview.innerHTML = `<img src="${reader.result}" style="max-width:100%; max-height:100%;">`;
      };
      reader.readAsDataURL(file);
    } else {
      preview.innerHTML = "Pr√©-visualiza√ß√£o";
    }
  });

  // üì• Carregar grupos da API
  async function carregarGrupos() {
    try {
      const resposta = await fetch("http://localhost:3000/grupos");
      const grupos = await resposta.json();
      for (let i = 1; i <= 5; i++) {
        const select = document.getElementById(`grupo${i}`);
        select.innerHTML = '<option value="">Selecione</option>';
        grupos.forEach(grupo => {
          const option = document.createElement("option");
          option.value = grupo.id;
          option.textContent = grupo.name;
          select.appendChild(option);
        });
      }
    } catch (erro) {
      console.error("Erro ao carregar grupos:", erro);
    }
  }

  // üì§ Enviar mensagem
  document.getElementById("enviar").addEventListener("click", async () => {
    const mensagem = document.getElementById("mensagem").value;
    const tempoSelecionado = document.querySelector('input[name="tempo"]:checked');
    const tempo = tempoSelecionado ? tempoSelecionado.value : "30";

    const grupos = [];
    for (let i = 1; i <= 5; i++) {
      const select = document.getElementById(`grupo${i}`);
      if (select.value) grupos.push(select.value);
    }

    const formData = new FormData();
    formData.append("mensagem", mensagem);
    formData.append("tempo", tempo);
    formData.append("grupos", JSON.stringify(grupos));
    if (imageInput.files[0]) {
      formData.append("imagem", imageInput.files[0]);
    }

    try {
      const resposta = await fetch("http://localhost:3000/agendar", {
        method: "POST",
        body: formData
      });
      const resultado = await resposta.json();
      document.getElementById("status").textContent = resultado.mensagem || "Mensagem agendada!";
      document.getElementById("ultimaMensagem").textContent = `Primeira mensagem enviada: ${new Date().toLocaleTimeString()}`;
      document.getElementById("resumoEnvio").textContent = `Mensagens enviadas: ${grupos.length} de 5`;
    } catch (erro) {
      console.error("Erro ao enviar:", erro);
      document.getElementById("status").textContent = "Erro ao agendar mensagem.";
    }
  });
</script>
</body>
</html>
